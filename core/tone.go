package core

import (
	"fmt"
	"os"
	"syscall"
	"unsafe"
)

// only pin 5 and 6 support tone function

const MAX_TONE_FREQ = 100000 //100kHz

type toneConfig struct {
	pin          byte
	clksrc_div   uint
	active_cycle uint
}

type toneFreq struct {
	freq, div, cycle uint
}

func findPWMSetting(freq uint) (pwm_source_div uint, pwm_active_cycle uint) {
	i := 0
	d1, d2 := 0, 0
	size := len(tone_freq)
	for i = 0; i < size-1; i++ {
		d1 = int(tone_freq[i].freq) - int(freq)
		if d1 < 0 {
			break
		}
		d2 = int(tone_freq[i+1].freq) - int(freq)
		if d2 < 0 {
			if -d2 < d1 {
				i++
			}
			break
		}
	}
	pwm_source_div = tone_freq[i].div
	pwm_active_cycle = tone_freq[i].cycle / 2
	return
}

func Tone(pin byte, freq uint /*duration uint64*/) error {
	if (pin != 5 && pin != 6) || freq > MAX_TONE_FREQ {
		return fmt.Errorf("invalid pin/frequency: %d/%d", pin, freq)
	}
	tc := &toneConfig{pin, 0, 0}
	if freq > 0 {
		tc.clksrc_div, tc.active_cycle = findPWMSetting(freq)
	}
	fd, err := syscall.Open(pwm_dev, os.O_RDONLY, 0666)
	if err != nil {
		return err
	}
	defer syscall.Close(fd)
	if err = Ioctl(fd, PWMTMR_TONE, uintptr(unsafe.Pointer(tc))); err != nil {
		return err
	}
	return nil
}

func NoTone(pin byte) error {
	if pin != 5 && pin != 6 {
		return fmt.Errorf("invalid pin: %d", pin)
	}
	tc := &toneConfig{pin, 0, 0}
	fd, err := syscall.Open(pwm_dev, os.O_RDONLY, 0666)
	if err != nil {
		return err
	}
	defer syscall.Close(fd)
	if err = Ioctl(fd, PWMTMR_TONE, uintptr(unsafe.Pointer(tc))); err != nil {
		return err
	}
	return nil
}

var tone_freq = []toneFreq{
	{100000, 120, 2},
	{66667, 180, 2},
	{50000, 240, 2},
	{33333, 360, 2},
	{25000, 480, 2},
	{22222, 180, 6},
	{20000, 120, 10},
	{16667, 360, 4},
	{14286, 120, 14},
	{13333, 180, 10},
	{12500, 480, 4},
	{11111, 360, 6},
	{10000, 240, 10},
	{9524, 180, 14},
	{9091, 120, 22},
	{8333, 480, 6},
	{7692, 120, 26},
	{7407, 180, 18},
	{7143, 240, 14},
	{6667, 360, 10},
	{6250, 480, 8},
	{6061, 180, 22},
	{5882, 120, 34},
	{5556, 360, 12},
	{5263, 120, 38},
	{5128, 180, 26},
	{5000, 480, 10},
	{4762, 360, 14},
	{4545, 240, 22},
	{4444, 180, 30},
	{4348, 120, 46},
	{4167, 480, 12},
	{4000, 120, 50},
	{3922, 180, 34},
	{3846, 240, 26},
	{3704, 360, 18},
	{3571, 480, 14},
	{3509, 180, 38},
	{3448, 120, 58},
	{3333, 360, 20},
	{3226, 120, 62},
	{3175, 180, 42},
	{3125, 480, 16},
	{3030, 360, 22},
	{2941, 240, 34},
	{2899, 180, 46},
	{2857, 120, 70},
	{2778, 480, 18},
	{2703, 120, 74},
	{2667, 180, 50},
	{2632, 240, 38},
	{2564, 360, 26},
	{2500, 480, 20},
	{2469, 180, 54},
	{2439, 120, 82},
	{2381, 360, 28},
	{2326, 120, 86},
	{2299, 180, 58},
	{2273, 480, 22},
	{2222, 360, 30},
	{2174, 240, 46},
	{2151, 180, 62},
	{2128, 120, 94},
	{2083, 480, 24},
	{2041, 120, 98},
	{2020, 180, 66},
	{2000, 240, 50},
	{1961, 360, 34},
	{1923, 480, 26},
	{1905, 180, 70},
	{1887, 120, 106},
	{1852, 360, 36},
	{1818, 120, 110},
	{1802, 180, 74},
	{1786, 480, 28},
	{1754, 360, 38},
	{1724, 240, 58},
	{1709, 180, 78},
	{1695, 120, 118},
	{1667, 480, 30},
	{1639, 120, 122},
	{1626, 180, 82},
	{1613, 240, 62},
	{1587, 360, 42},
	{1563, 480, 32},
	{1550, 180, 86},
	{1538, 120, 130},
	{1515, 360, 44},
	{1493, 120, 134},
	{1481, 180, 90},
	{1471, 480, 34},
	{1449, 360, 46},
	{1429, 240, 70},
	{1418, 180, 94},
	{1408, 120, 142},
	{1389, 480, 36},
	{1370, 120, 146},
	{1361, 180, 98},
	{1351, 240, 74},
	{1333, 360, 50},
	{1316, 480, 38},
	{1307, 180, 102},
	{1299, 120, 154},
	{1282, 360, 52},
	{1266, 120, 158},
	{1258, 180, 106},
	{1250, 480, 40},
	{1235, 360, 54},
	{1220, 240, 82},
	{1212, 180, 110},
	{1205, 120, 166},
	{1190, 480, 42},
	{1176, 120, 170},
	{1170, 180, 114},
	{1163, 240, 86},
	{1149, 360, 58},
	{1136, 480, 44},
	{1130, 180, 118},
	{1124, 120, 178},
	{1111, 360, 60},
	{1099, 120, 182},
	{1093, 180, 122},
	{1087, 480, 46},
	{1075, 360, 62},
	{1064, 240, 94},
	{1058, 180, 126},
	{1053, 120, 190},
	{1042, 480, 48},
	{1031, 120, 194},
	{1026, 180, 130},
	{1020, 240, 98},
	{1010, 360, 66},
	{1000, 12000, 2},
	{995, 180, 134},
	{990, 120, 202},
	{980, 360, 68},
	{971, 120, 206},
	{966, 180, 138},
	{962, 480, 52},
	{952, 360, 70},
	{943, 240, 106},
	{939, 180, 142},
	{935, 120, 214},
	{926, 480, 54},
	{917, 120, 218},
	{913, 180, 146},
	{909, 240, 110},
	{901, 360, 74},
	{893, 480, 56},
	{889, 180, 150},
	{885, 120, 226},
	{877, 360, 76},
	{870, 120, 230},
	{866, 180, 154},
	{862, 480, 58},
	{855, 360, 78},
	{847, 240, 118},
	{844, 180, 158},
	{840, 120, 238},
	{833, 480, 60},
	{826, 120, 242},
	{823, 180, 162},
	{820, 240, 122},
	{813, 360, 82},
	{806, 480, 62},
	{803, 180, 166},
	{800, 120, 250},
	{794, 360, 84},
	{787, 120, 254},
	{784, 180, 170},
	{781, 480, 64},
	{775, 360, 86},
	{769, 240, 130},
	{766, 180, 174},
	{758, 480, 66},
	{749, 180, 178},
	{746, 240, 134},
	{741, 360, 90},
	{735, 480, 68},
	{733, 180, 182},
	{725, 360, 92},
	{717, 180, 186},
	{714, 480, 70},
	{709, 360, 94},
	{704, 240, 142},
	{702, 180, 190},
	{694, 480, 72},
	{687, 180, 194},
	{685, 240, 146},
	{680, 360, 98},
	{676, 480, 74},
	{673, 180, 198},
	{667, 360, 100},
	{660, 180, 202},
	{658, 480, 76},
	{654, 360, 102},
	{649, 240, 154},
	{647, 180, 206},
	{641, 480, 78},
	{635, 180, 210},
	{633, 240, 158},
	{629, 360, 106},
	{625, 480, 80},
	{623, 180, 214},
	{617, 360, 108},
	{612, 180, 218},
	{610, 480, 82},
	{606, 360, 110},
	{602, 240, 166},
	{601, 180, 222},
	{595, 480, 84},
	{590, 180, 226},
	{588, 240, 170},
	{585, 360, 114},
	{581, 480, 86},
	{580, 180, 230},
	{575, 360, 116},
	{570, 180, 234},
	{568, 480, 88},
	{565, 360, 118},
	{562, 240, 178},
	{560, 180, 238},
	{556, 480, 90},
	{551, 180, 242},
	{549, 240, 182},
	{546, 360, 122},
	{543, 480, 92},
	{542, 180, 246},
	{538, 360, 124},
	{533, 180, 250},
	{532, 480, 94},
	{529, 360, 126},
	{526, 240, 190},
	{525, 180, 254},
	{521, 480, 96},
	{515, 240, 194},
	{513, 360, 130},
	{510, 480, 98},
	{505, 360, 132},
	{500, 24000, 2},
	{498, 360, 134},
	{495, 240, 202},
	{490, 480, 102},
	{485, 240, 206},
	{483, 360, 138},
	{481, 480, 104},
	{476, 360, 140},
	{472, 480, 106},
	{469, 360, 142},
	{467, 240, 214},
	{463, 480, 108},
	{459, 240, 218},
	{457, 360, 146},
	{455, 480, 110},
	{450, 360, 148},
	{446, 480, 112},
	{444, 360, 150},
	{442, 240, 226},
	{439, 480, 114},
	{435, 240, 230},
	{433, 360, 154},
	{431, 480, 116},
	{427, 360, 156},
	{424, 480, 118},
	{422, 360, 158},
	{420, 240, 238},
	{417, 480, 120},
	{413, 240, 242},
	{412, 360, 162},
	{410, 480, 122},
	{407, 360, 164},
	{403, 480, 124},
	{402, 360, 166},
	{400, 240, 250},
	{397, 480, 126},
	{394, 240, 254},
	{392, 360, 170},
	{391, 480, 128},
	{388, 360, 172},
	{385, 480, 130},
	{383, 360, 174},
	{379, 480, 132},
	{375, 360, 178},
	{373, 480, 134},
	{370, 360, 180},
	{368, 480, 136},
	{366, 360, 182},
	{362, 480, 138},
	{358, 360, 186},
	{357, 480, 140},
	{355, 360, 188},
	{352, 480, 142},
	{351, 360, 190},
	{347, 480, 144},
	{344, 360, 194},
	{342, 480, 146},
	{340, 360, 196},
	{338, 480, 148},
	{337, 360, 198},
	{333, 36000, 2},
	{330, 360, 202},
	{329, 480, 152},
	{327, 360, 204},
	{325, 480, 154},
	{324, 360, 206},
	{321, 480, 156},
	{317, 360, 210},
	{316, 480, 158},
	{314, 360, 212},
	{313, 480, 160},
	{312, 360, 214},
	{309, 480, 162},
	{306, 360, 218},
	{305, 480, 164},
	{303, 360, 220},
	{301, 480, 166},
	{300, 360, 222},
	{298, 480, 168},
	{295, 360, 226},
	{294, 480, 170},
	{292, 360, 228},
	{291, 480, 172},
	{290, 360, 230},
	{287, 480, 174},
	{285, 360, 234},
	{284, 480, 176},
	{282, 360, 236},
	{281, 480, 178},
	{280, 360, 238},
	{278, 480, 180},
	{275, 480, 182},
	{273, 360, 244},
	{272, 480, 184},
	{271, 360, 246},
	{269, 480, 186},
	{267, 360, 250},
	{266, 480, 188},
	{265, 360, 252},
	{263, 480, 190},
	{262, 360, 254},
	{260, 480, 192},
	{258, 480, 194},
	{255, 480, 196},
	{253, 480, 198},
	{250, 48000, 2},
	{248, 480, 202},
	{245, 480, 204},
	{243, 480, 206},
	{240, 480, 208},
	{238, 480, 210},
	{236, 480, 212},
	{234, 480, 214},
	{231, 480, 216},
	{229, 480, 218},
	{227, 480, 220},
	{225, 480, 222},
	{223, 480, 224},
	{221, 480, 226},
	{219, 480, 228},
	{217, 480, 230},
	{216, 480, 232},
	{214, 480, 234},
	{212, 480, 236},
	{210, 480, 238},
	{208, 480, 240},
	{207, 480, 242},
	{205, 480, 244},
	{203, 480, 246},
	{202, 480, 248},
	{200, 12000, 10},
	{198, 480, 252},
	{197, 480, 254},
	{195, 480, 256},
	{167, 72000, 2},
	{143, 12000, 14},
	{125, 48000, 4},
	{111, 36000, 6},
	{100, 24000, 10},
	{91, 12000, 22},
	{83, 72000, 4},
	{77, 12000, 26},
	{71, 24000, 14},
	{67, 36000, 10},
	{63, 48000, 8},
	{59, 12000, 34},
	{56, 72000, 6},
	{53, 12000, 38},
	{50, 48000, 10},
	{48, 36000, 14},
	{45, 24000, 22},
	{43, 12000, 46},
	{42, 72000, 8},
	{40, 12000, 50},
	{38, 24000, 26},
	{37, 36000, 18},
	{36, 48000, 14},
	{34, 12000, 58},
	{33, 72000, 10},
	{32, 12000, 62},
	{31, 48000, 16},
	{30, 36000, 22},
	{29, 24000, 34},
	{28, 72000, 12},
	{27, 12000, 74},
	{26, 36000, 26},
	{25, 48000, 20},
	{24, 72000, 14},
	{23, 48000, 22},
	{22, 36000, 30},
	{21, 72000, 16},
	{20, 36000, 34},
	{19, 72000, 18},
	{18, 48000, 28},
	{17, 72000, 20},
	{16, 48000, 32},
	{15, 72000, 22},
	{14, 72000, 24},
	{13, 72000, 26},
	{12, 72000, 28},
	{11, 72000, 30},
	{10, 72000, 34},
	{9, 72000, 38},
	{8, 72000, 44},
	{7, 72000, 50},
	{6, 72000, 60},
	{5, 72000, 74},
	{4, 72000, 94},
	{3, 72000, 132},
	{2, 72000, 222},
	{1, 72000, 256},
}

const (
	NOTE_B0  = 31
	NOTE_C1  = 33
	NOTE_CS1 = 35
	NOTE_D1  = 37
	NOTE_DS1 = 39
	NOTE_E1  = 41
	NOTE_F1  = 44
	NOTE_FS1 = 46
	NOTE_G1  = 49
	NOTE_GS1 = 52
	NOTE_A1  = 55
	NOTE_AS1 = 58
	NOTE_B1  = 62
	NOTE_C2  = 65
	NOTE_CS2 = 69
	NOTE_D2  = 73
	NOTE_DS2 = 78
	NOTE_E2  = 82
	NOTE_F2  = 87
	NOTE_FS2 = 93
	NOTE_G2  = 98
	NOTE_GS2 = 104
	NOTE_A2  = 110
	NOTE_AS2 = 117
	NOTE_B2  = 123
	NOTE_C3  = 131
	NOTE_CS3 = 139
	NOTE_D3  = 147
	NOTE_DS3 = 156
	NOTE_E3  = 165
	NOTE_F3  = 175
	NOTE_FS3 = 185
	NOTE_G3  = 196
	NOTE_GS3 = 208
	NOTE_A3  = 220
	NOTE_AS3 = 233
	NOTE_B3  = 247
	NOTE_C4  = 262
	NOTE_CS4 = 277
	NOTE_D4  = 294
	NOTE_DS4 = 311
	NOTE_E4  = 330
	NOTE_F4  = 349
	NOTE_FS4 = 370
	NOTE_G4  = 392
	NOTE_GS4 = 415
	NOTE_A4  = 440
	NOTE_AS4 = 466
	NOTE_B4  = 494
	NOTE_C5  = 523
	NOTE_CS5 = 554
	NOTE_D5  = 587
	NOTE_DS5 = 622
	NOTE_E5  = 659
	NOTE_F5  = 698
	NOTE_FS5 = 740
	NOTE_G5  = 784
	NOTE_GS5 = 831
	NOTE_A5  = 880
	NOTE_AS5 = 932
	NOTE_B5  = 988
	NOTE_C6  = 1047
	NOTE_CS6 = 1109
	NOTE_D6  = 1175
	NOTE_DS6 = 1245
	NOTE_E6  = 1319
	NOTE_F6  = 1397
	NOTE_FS6 = 1480
	NOTE_G6  = 1568
	NOTE_GS6 = 1661
	NOTE_A6  = 1760
	NOTE_AS6 = 1865
	NOTE_B6  = 1976
	NOTE_C7  = 2093
	NOTE_CS7 = 2217
	NOTE_D7  = 2349
	NOTE_DS7 = 2489
	NOTE_E7  = 2637
	NOTE_F7  = 2794
	NOTE_FS7 = 2960
	NOTE_G7  = 3136
	NOTE_GS7 = 3322
	NOTE_A7  = 3520
	NOTE_AS7 = 3729
	NOTE_B7  = 3951
	NOTE_C8  = 4186
	NOTE_CS8 = 4435
	NOTE_D8  = 4699
	NOTE_DS8 = 4978
)
